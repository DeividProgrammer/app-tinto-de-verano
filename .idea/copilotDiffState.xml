<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/mu-session/app.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/mu-session/app.js" />
              <option name="updatedContent" value="import { app, errorHandler, query, uuid } from 'mu';&#10;&#10;// Middleware para establecer headers JSON:API&#10;app.use((req, res, next) =&gt; {&#10;  res.set('Content-Type', 'application/vnd.api+json');&#10;  next();&#10;});&#10;&#10;/**&#10; * POST /session&#10; * Login simple por email (sin validar password para MVP)&#10; * &#10; * Body ejemplo:&#10; * {&#10; *   &quot;data&quot;: {&#10; *     &quot;attributes&quot;: {&#10; *       &quot;email&quot;: &quot;charlie@example.com&quot;&#10; *     }&#10; *   }&#10; * }&#10; * &#10; * Respuesta:&#10; * - Crea sesión en Virtuoso&#10; * - Devuelve MU_SESSION_ID en cookie y header&#10; */&#10;app.post('/session', async (req, res) =&gt; {&#10;  try {&#10;    const email = req.body?.data?.attributes?.email;&#10;    &#10;    if (!email) {&#10;      return res.status(400).send({ &#10;        errors: [{ title: 'Email is required' }] &#10;      });&#10;    }&#10;&#10;    console.log(`[POST /session] Login attempt for email: ${email}`);&#10;&#10;    // Escapar comillas para SPARQL&#10;    const escapedEmail = email.replace(/&quot;/g, '\\&quot;');&#10;&#10;    // 1. Buscar el account por email&#10;    const accountQuery = `&#10;      PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;&#10;      PREFIX mu:   &lt;http://mu.semte.ch/vocabularies/core/&gt;&#10;&#10;      SELECT ?account ?accountUuid WHERE {&#10;        GRAPH &lt;http://mu.semte.ch/graphs/public&gt; {&#10;          ?account a foaf:OnlineAccount ;&#10;                   foaf:accountName &quot;${escapedEmail}&quot; ;&#10;                   mu:uuid ?accountUuid .&#10;        }&#10;      } LIMIT 1&#10;    `;&#10;&#10;    const accountResult = await query(accountQuery);&#10;    const accountBindings = accountResult.results.bindings;&#10;&#10;    if (!accountBindings.length) {&#10;      console.log(`[POST /session] Account not found for: ${email}`);&#10;      return res.status(404).send({ &#10;        errors: [{ title: 'Account not found. Please register first.' }] &#10;      });&#10;    }&#10;&#10;    const accountUri = accountBindings[0].account.value;&#10;    const accountUuid = accountBindings[0].accountUuid.value;&#10;&#10;    console.log(`[POST /session] Found account: ${accountUri}`);&#10;&#10;    // 2. Crear sesión&#10;    const sessionId = uuid();&#10;    const sessionUri = `http://tinto.app/sessions/${sessionId}`;&#10;&#10;    const insertSessionQuery = `&#10;      PREFIX mu:      &lt;http://mu.semte.ch/vocabularies/core/&gt;&#10;      PREFIX session: &lt;http://mu.semte.ch/vocabularies/session/&gt;&#10;&#10;      INSERT DATA {&#10;        GRAPH &lt;http://mu.semte.ch/graphs/sessions&gt; {&#10;          &lt;${sessionUri}&gt;&#10;            a session:Session ;&#10;            mu:uuid &quot;${sessionId}&quot; ;&#10;            session:account &lt;${accountUri}&gt; .&#10;        }&#10;      }&#10;    `;&#10;&#10;    await query(insertSessionQuery);&#10;&#10;    console.log(`[POST /session] Session created: ${sessionId}`);&#10;&#10;    // 3. Establecer cookie y header&#10;    res.cookie('MU_SESSION_ID', sessionId, { &#10;      httpOnly: false,&#10;      path: '/'&#10;    });&#10;    res.set('MU-SESSION-ID', sessionId);&#10;&#10;    return res.status(201).send({&#10;      data: {&#10;        type: 'sessions',&#10;        id: sessionId,&#10;        attributes: {&#10;          email: email&#10;        },&#10;        relationships: {&#10;          account: {&#10;            data: {&#10;              type: 'accounts',&#10;              id: accountUuid&#10;            }&#10;          }&#10;        }&#10;      }&#10;    });&#10;&#10;  } catch (error) {&#10;    console.error('[POST /session] Error:', error);&#10;    return res.status(500).send({ &#10;      errors: [{ title: 'Internal server error', detail: error.message }] &#10;    });&#10;  }&#10;});&#10;&#10;/**&#10; * GET /me&#10; * Obtiene el usuario actual a partir de MU_SESSION_ID&#10; * &#10; * Headers/Cookies:&#10; * - Cookie: MU_SESSION_ID=&lt;uuid&gt;&#10; * o&#10; * - MU-SESSION-ID: &lt;uuid&gt;&#10; * &#10; * Respuesta:&#10; * {&#10; *   &quot;data&quot;: {&#10; *     &quot;type&quot;: &quot;users&quot;,&#10; *     &quot;id&quot;: &quot;user-uuid&quot;,&#10; *     &quot;attributes&quot;: {&#10; *       &quot;name&quot;: &quot;Charlie Brown&quot;,&#10; *       &quot;email&quot;: &quot;charlie@example.com&quot;&#10; *     }&#10; *   }&#10; * }&#10; */&#10;app.get('/me', async (req, res) =&gt; {&#10;  try {&#10;    // Leer sessionId de cookie o header&#10;    const sessionId = req.get('MU-SESSION-ID') || req.headers['mu-session-id'];&#10;    &#10;    if (!sessionId) {&#10;      return res.status(401).send({ &#10;        errors: [{ title: 'MU_SESSION_ID is required. Please login first.' }] &#10;      });&#10;    }&#10;&#10;    console.log(`[GET /me] Looking up user for session: ${sessionId}`);&#10;&#10;    const escapedSessionId = sessionId.replace(/&quot;/g, '\\&quot;');&#10;&#10;    // Consulta para obtener usuario a través de: sesión → account → user&#10;    const userQuery = `&#10;      PREFIX mu:      &lt;http://mu.semte.ch/vocabularies/core/&gt;&#10;      PREFIX foaf:    &lt;http://xmlns.com/foaf/0.1/&gt;&#10;      PREFIX session: &lt;http://mu.semte.ch/vocabularies/session/&gt;&#10;&#10;      SELECT ?user ?userUuid ?name ?email ?accountName WHERE {&#10;        # 1. Encontrar sesión&#10;        GRAPH &lt;http://mu.semte.ch/graphs/sessions&gt; {&#10;          ?session a session:Session ;&#10;                   mu:uuid &quot;${escapedSessionId}&quot; ;&#10;                   session:account ?account .&#10;        }&#10;&#10;        # 2. Obtener email del account&#10;        GRAPH &lt;http://mu.semte.ch/graphs/public&gt; {&#10;          ?account a foaf:OnlineAccount ;&#10;                   foaf:accountName ?accountName .&#10;        }&#10;&#10;        # 3. Encontrar usuario vinculado al account&#10;        GRAPH &lt;http://mu.semte.ch/graphs/users&gt; {&#10;          ?account foaf:account ?user .&#10;        }&#10;&#10;        # 4. Obtener datos del usuario&#10;        GRAPH &lt;http://mu.semte.ch/graphs/public&gt; {&#10;          ?user a foaf:Person ;&#10;                mu:uuid ?userUuid ;&#10;                foaf:name ?name .&#10;          &#10;          OPTIONAL { ?user foaf:mbox ?email }&#10;        }&#10;      } LIMIT 1&#10;    `;&#10;&#10;    const userResult = await query(userQuery);&#10;    const userBindings = userResult.results.bindings;&#10;&#10;    if (!userBindings.length) {&#10;      console.log(`[GET /me] No user found for session: ${sessionId}`);&#10;      return res.status(404).send({ &#10;        errors: [{ title: 'Session not found or expired. Please login again.' }] &#10;      });&#10;    }&#10;&#10;    const userData = userBindings[0];&#10;    const userName = userData.name.value;&#10;    const userEmail = userData.email?.value || userData.accountName.value;&#10;    const userUuid = userData.userUuid.value;&#10;&#10;    console.log(`[GET /me] Found user: ${userName} (${userEmail})`);&#10;&#10;    return res.status(200).send({&#10;      data: {&#10;        type: 'users',&#10;        id: userUuid,&#10;        attributes: {&#10;          name: userName,&#10;          email: userEmail&#10;        }&#10;      }&#10;    });&#10;&#10;  } catch (error) {&#10;    console.error('[GET /me] Error:', error);&#10;    return res.status(500).send({ &#10;      errors: [{ title: 'Internal server error', detail: error.message }] &#10;    });&#10;  }&#10;});&#10;&#10;/**&#10; * DELETE /session (logout)&#10; * Elimina la sesión actual&#10; */&#10;app.delete('/session', async (req, res) =&gt; {&#10;  try {&#10;    const sessionId = req.get('MU-SESSION-ID') || req.headers['mu-session-id'];&#10;    &#10;    if (!sessionId) {&#10;      return res.status(401).send({ &#10;        errors: [{ title: 'MU_SESSION_ID is required' }] &#10;      });&#10;    }&#10;&#10;    console.log(`[DELETE /session] Logging out session: ${sessionId}`);&#10;&#10;    const escapedSessionId = sessionId.replace(/&quot;/g, '\\&quot;');&#10;&#10;    const deleteSessionQuery = `&#10;      PREFIX mu:      &lt;http://mu.semte.ch/vocabularies/core/&gt;&#10;      PREFIX session: &lt;http://mu.semte.ch/vocabularies/session/&gt;&#10;&#10;      DELETE WHERE {&#10;        GRAPH &lt;http://mu.semte.ch/graphs/sessions&gt; {&#10;          ?session a session:Session ;&#10;                   mu:uuid &quot;${escapedSessionId}&quot; ;&#10;                   ?p ?o .&#10;        }&#10;      }&#10;    `;&#10;&#10;    await query(deleteSessionQuery);&#10;&#10;    console.log(`[DELETE /session] Session deleted: ${sessionId}`);&#10;&#10;    res.clearCookie('MU_SESSION_ID');&#10;&#10;    return res.status(204).send();&#10;&#10;  } catch (error) {&#10;    console.error('[DELETE /session] Error:', error);&#10;    return res.status(500).send({ &#10;      errors: [{ title: 'Internal server error', detail: error.message }] &#10;    });&#10;  }&#10;});&#10;&#10;// Error handler&#10;app.use(errorHandler);&#10;&#10;console.log(' mu-session service started');&#10;console.log('   POST /session  - Login by email');&#10;console.log('   GET  /me       - Get current user');&#10;console.log('   DELETE /session - Logout');&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>